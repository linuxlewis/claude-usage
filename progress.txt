# Ralph Progress Log
Started: 2026-02-09T01:34:52.881Z

## Codebase Patterns
- Use Xcode project (not SPM) since MenuBarExtra requires app bundle with Info.plist
- Build command: `xcodebuild -scheme ClaudeUsage -destination 'platform=macOS' build`
- Test command: `xcodebuild test -scheme ClaudeUsage -destination 'platform=macOS'`
- Source files in ClaudeUsage/ directory, tests in ClaudeUsageTests/
- When adding new .swift files, they must be added to the pbxproj file with PBXFileReference, PBXBuildFile, and added to the Sources build phase
- Info.plist is at ClaudeUsage/Info.plist with LSUIElement=true for menu bar-only app
- UsageViewModel.startPollingIfConfigured() must be called after saving new credentials to restart the polling loop
- ErrorState must be Equatable to use == in SwiftUI view conditionals (e.g. `if viewModel.errorState == .authExpired`)
- API dates use ISO8601 with fractional seconds (e.g. "2026-02-08T18:59:59.661633+00:00") — use custom dateDecodingStrategy with ISO8601DateFormatter(.withFractionalSeconds) and fallback
- The usage API response has `resets_at` as a nullable Date string even within non-null limit objects (e.g. seven_day_sonnet can have utilization: 0.0 with resets_at: null)
- pbxproj IDs follow pattern: AA000010 for PBXBuildFile, AA100013 for PBXFileReference — increment from last used
- Avoid complex array concatenation expressions with optionals in Swift — the type checker will time out. Use compactMap or imperative append instead
- UsageViewModel is the shared ObservableObject passed from ClaudeUsageApp to ContentView and future views
- ContentView takes `@ObservedObject var viewModel: UsageViewModel` — all views that need usage data get it from viewModel
- KeychainService uses service name "com.claudeusage.credentials" with account keys "sessionKey" and "orgId"
- UsageService uses URLSession with dependency injection (pass custom session for testing)
- SMAppService (macOS 13+) for Launch at Login: register()/unregister() throw, check status == .enabled for current state
- Use URLProtocol subclass mock for testing URLSession-based network code — register via URLSessionConfiguration.ephemeral with protocolClasses
- AccountStore manages multi-account state: accounts array, activeAccountId, persistence to UserDefaults (metadata) + Keychain (secrets scoped by "{accountId}-sessionKey")
- UsageViewModel takes AccountStore in init and subscribes to accountStore.$activeAccountId for automatic polling restart on account switch
- ContentView and SettingsView both accept @ObservedObject accountStore — passed down from ClaudeUsageApp through ContentView
- Account struct in Models/Account.swift, AccountStore in Services/AccountStore.swift
- KeychainService multi-account methods use accountId parameter: save(key:accountId:value:), read(key:accountId:), delete(key:accountId:)

---

## 2026-02-08 20:06 - US-001
- What was implemented: Xcode project scaffold with SwiftUI MenuBarExtra app, Info.plist with LSUIElement=true, and XCTest target
- Files changed:
  - ClaudeUsage.xcodeproj/project.pbxproj (new - Xcode project definition)
  - ClaudeUsage.xcodeproj/xcshareddata/xcschemes/ClaudeUsage.xcscheme (new - shared scheme)
  - ClaudeUsage/ClaudeUsageApp.swift (new - SwiftUI @main app with MenuBarExtra)
  - ClaudeUsage/Views/ContentView.swift (new - placeholder popover content)
  - ClaudeUsage/Info.plist (new - app metadata with LSUIElement=true)
  - ClaudeUsageTests/ClaudeUsageTests.swift (new - basic test target)
  - CLAUDE.md (updated - corrected build commands and directory paths)
- **Learnings for future iterations:**
  - MenuBarExtra requires an app bundle, so SPM executable won't work — must use Xcode project
  - pbxproj uses unique IDs (AA000001 format used here) — new files need entries in PBXFileReference, PBXBuildFile, and the relevant PBXSourcesBuildPhase
  - The scheme file must reference the correct BlueprintIdentifier matching the PBXNativeTarget ID
  - macOS deployment target is set to 13.0 in both project and target build settings
  - Swift 6.2.1 is on this machine, but project uses SWIFT_VERSION = 5.0 for compatibility
---

## 2026-02-08 20:09 - US-002
- What was implemented: UsageData and UsageLimit Codable models for decoding the claude.ai usage API response. All optional fields (seven_day_opus, seven_day_cowork, seven_day_oauth_apps, iguana_necktie, extra_usage) are Swift Optionals. Added 4 unit tests covering full response decoding, null optional fields, all fields present, and utilization value accuracy.
- Files changed:
  - ClaudeUsage/Models/UsageData.swift (new - UsageLimit and UsageData Codable models)
  - ClaudeUsageTests/ClaudeUsageTests.swift (updated - added 4 JSON decoding tests)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added UsageData.swift to project)
  - prd.json (updated - US-002 passes: true)
- **Learnings for future iterations:**
  - API date format includes fractional seconds — need custom ISO8601 decoder with .withFractionalSeconds option
  - XCTAssertEqual with accuracy: parameter requires non-optional Double — use force unwrap (!) for optional values in test assertions where the value is known to exist
  - resets_at can be null even when the limit object itself is non-null (e.g. seven_day_sonnet with utilization 0.0)
  - New .swift files need 4 pbxproj entries: PBXFileReference, PBXBuildFile, group children, and Sources build phase files
---

## 2026-02-08 20:12 - US-003
- What was implemented: KeychainService struct with static methods for saving, reading, and deleting session key and org ID from macOS Keychain. Uses Security framework (SecItemAdd, SecItemCopyMatching, SecItemDelete) with service name "com.claudeusage.credentials".
- Files changed:
  - ClaudeUsage/Services/KeychainService.swift (new - Keychain CRUD operations)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added KeychainService.swift to project)
  - prd.json (updated - US-003 passes: true)
- **Learnings for future iterations:**
  - Keychain operations are hard to unit test in CI (require entitlements and user keychain access), so build-only verification is sufficient
  - Always delete before adding in Keychain to handle updates — SecItemAdd fails with errSecDuplicateItem if key already exists
  - @discardableResult on delete() is useful since callers often don't care about the delete result (e.g., when called as cleanup before save)
  - Security framework is available by default on macOS — no additional framework linking needed in pbxproj
---

## 2026-02-08 20:15 - US-004
- What was implemented: UsageService struct that fetches usage data from the claude.ai API. Uses URLSession with sessionKey cookie and anthropic-client-platform header. Returns decoded UsageData plus optional new session key from Set-Cookie. Handles 401/403 as specific AuthError type. Added 5 unit tests using URLProtocol mock: request construction, JSON decoding, Set-Cookie parsing, 401 auth error, 403 auth error.
- Files changed:
  - ClaudeUsage/Services/UsageService.swift (new - API client with fetchUsage(), error types, Set-Cookie parsing)
  - ClaudeUsageTests/ClaudeUsageTests.swift (updated - added UsageServiceTests class with 5 tests)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added UsageService.swift to project)
  - prd.json (updated - US-004 passes: true)
- **Learnings for future iterations:**
  - URLProtocol mock pattern: create a subclass with static requestHandler and capturedRequest, register via URLSessionConfiguration.ephemeral with protocolClasses
  - UsageService takes sessionKey, orgId, and URLSession as init params — URLSession defaults to .shared for production, test passes custom mock session
  - Set-Cookie header is accessed via allHeaderFields["Set-Cookie"] on HTTPURLResponse — note the key is case-sensitive when accessing via dictionary
  - fetchUsage() returns a tuple (UsageData, newSessionKey: String?) so callers can update Keychain when a new key is received
---

## 2026-02-08 20:17 - US-005
- What was implemented: CircleProgress SwiftUI view component that draws a circular progress ring. Takes percentage (0-100) and optional size parameter. Ring fills proportionally via Circle().trim(). Color-coded: green (<50%), yellow (50-79%), red (>=80%). Background ring in gray at 0.2 opacity. Line width scales with size (15% of diameter) for consistent appearance at 16x16 and 32x32.
- Files changed:
  - ClaudeUsage/Views/CircleProgress.swift (new - reusable circular progress ring component)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added CircleProgress.swift to project)
  - prd.json (updated - US-005 passes: true)
- **Learnings for future iterations:**
  - Circle().trim(from:to:) draws clockwise from the "3 o'clock" position — use .rotationEffect(.degrees(-90)) to start from top
  - StrokeStyle with lineCap: .round gives polished rounded ends on the progress arc
  - Making lineWidth proportional to size (size * 0.15) ensures the ring looks good at both 16x16 menu bar size and 32x32 popover size
  - Clamping percentage with min(max(percentage, 0), 100) prevents visual bugs from out-of-range values
---

## 2026-02-08 20:20 - US-006
- What was implemented: Menu bar icon showing CircleProgress ring with highest utilization percentage and reset time in local timezone. Created UsageViewModel (ObservableObject) that computes highest utilization across all limits and formats reset time. Updated ClaudeUsageApp to use custom MenuBarExtra label with HStack of CircleProgress + Text. Updated ContentView to accept viewModel.
- Files changed:
  - ClaudeUsage/Models/UsageViewModel.swift (new - ObservableObject with highestUtilization, highestResetDate, resetTimeString)
  - ClaudeUsage/ClaudeUsageApp.swift (updated - @StateObject viewModel, custom MenuBarExtra label with ring + time)
  - ClaudeUsage/Views/ContentView.swift (updated - accepts @ObservedObject viewModel)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added UsageViewModel.swift to project)
  - prd.json (updated - US-006 passes: true)
- **Learnings for future iterations:**
  - Swift type checker times out on complex array concatenation with Optional.map — use compactMap or imperative loops instead
  - MenuBarExtra label: closure supports SwiftUI views like HStack with CircleProgress and Text
  - DateFormatter with "h:mm a" for time-only, "EEE h:mm a" for day+time — check Calendar.isDate(_:inSameDayAs:) to decide format
  - UsageViewModel holds shared state (@Published usageData, lastUpdated, errorState) for use across menu bar label and popover
---

## 2026-02-08 20:23 - US-007
- What was implemented: Usage popover with all limits displayed. Created UsageBar component showing name, circular ring, percentage, horizontal progress bar, and reset time. Updated ContentView to iterate over all non-nil limits using a new displayLimits computed property on UsageViewModel. Added "Updated X ago" footer with refresh and settings buttons. Added lastUpdatedString, displayLimits, refreshRequested, and settingsRequested to UsageViewModel.
- Files changed:
  - ClaudeUsage/Views/UsageBar.swift (new - single usage bar component with ring, bar, and reset time)
  - ClaudeUsage/Views/ContentView.swift (updated - full popover with ForEach over displayLimits, footer with refresh/settings)
  - ClaudeUsage/Models/UsageViewModel.swift (updated - added lastUpdatedString, displayLimits, refreshRequested, settingsRequested)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added UsageBar.swift to project)
  - prd.json (updated - US-007 passes: true)
- **Learnings for future iterations:**
  - Use GeometryReader for horizontal progress bars to get parent width for proportional fill
  - ForEach with enumerated() and id: \.offset works for iterating tuples that aren't Identifiable
  - UsageBar reuses the same color logic as CircleProgress for consistent color-coding across ring and bar
  - refreshRequested/settingsRequested as @Published Bool flags on viewModel allow child views to signal actions to parent
---

## 2026-02-08 20:26 - US-008
- What was implemented: Settings view accessible from the popover via gear icon. Contains a SecureField for session key, TextField for org ID, Save and Test Connection buttons, and auth status indicator (connected/expired/not configured). SettingsView uses KeychainService to load/save credentials and UsageService to test the connection. Added AuthStatus enum and updateAuthStatus() to UsageViewModel. Updated ContentView to toggle between usage view and settings view based on settingsRequested flag. Added "Open Settings" button to the "Not configured" state.
- Files changed:
  - ClaudeUsage/Views/SettingsView.swift (new - settings UI with auth fields, test connection, status)
  - ClaudeUsage/Views/ContentView.swift (updated - toggles between usage and settings views)
  - ClaudeUsage/Models/UsageViewModel.swift (updated - added AuthStatus enum, updateAuthStatus())
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added SettingsView.swift to project)
  - prd.json (updated - US-008 passes: true)
- **Learnings for future iterations:**
  - Use @State for local form inputs in settings, load from Keychain in .onAppear
  - SettingsView takes @ObservedObject viewModel to share auth status with the rest of the app
  - SwiftUI SecureField works well for session key entry — same API as TextField
  - Test connection creates a temporary UsageService with the input values, not the saved ones
  - Back navigation is done by toggling viewModel.settingsRequested = false
---

## 2026-02-08 20:28 - US-009
- What was implemented: Automatic polling with 5-minute interval using async Task.sleep. UsageViewModel now has startPollingIfConfigured() that launches a polling loop, performFetch() that calls UsageService and updates state, and fetchNow() for manual refresh. Error states (auth expired, network error) are shown in both the menu bar icon and the popover. Auth errors (401/403) show a red exclamation circle and prompt to re-auth. Network errors show an orange warning triangle. Set-Cookie session key updates are saved to Keychain automatically. SettingsView calls startPollingIfConfigured() after saving credentials to restart the polling loop.
- Files changed:
  - ClaudeUsage/Models/UsageViewModel.swift (updated - added polling logic, performFetch, fetchNow, startPollingIfConfigured, made ErrorState Equatable)
  - ClaudeUsage/ClaudeUsageApp.swift (updated - menu bar label shows error state icons for auth expired and network error)
  - ClaudeUsage/Views/ContentView.swift (updated - popover shows auth expired state with re-auth prompt, network error in footer, refresh calls fetchNow() directly)
  - ClaudeUsage/Views/SettingsView.swift (updated - calls startPollingIfConfigured() after saving credentials)
  - prd.json (updated - US-009 passes: true)
- **Learnings for future iterations:**
  - Use async Task.sleep(nanoseconds:) for polling intervals — cleaner than Timer.publish in a Combine-less context
  - performFetch must be @MainActor since it updates @Published properties
  - Re-read credentials from Keychain on each poll iteration in case they were updated by Set-Cookie or settings
  - ErrorState needs Equatable conformance for SwiftUI conditional checks (== operator)
  - Cancel the previous pollingTask before starting a new one in startPollingIfConfigured() to avoid multiple concurrent loops
  - ContentView refresh button should call fetchNow() directly instead of toggling a Bool flag — simpler and more reliable
---

## 2026-02-08 20:31 - US-010
- What was implemented: Launch at Login toggle in Settings view using SMAppService (macOS 13+). Added a Toggle that calls SMAppService.mainApp.register()/unregister(). The toggle reflects the current registration state on load by checking SMAppService.mainApp.status == .enabled. If registration fails, the toggle reverts.
- Files changed:
  - ClaudeUsage/Views/SettingsView.swift (updated - added import ServiceManagement, launchAtLogin @State, Toggle with onChange handler, onAppear status check)
  - prd.json (updated - US-010 passes: true)
- **Learnings for future iterations:**
  - SMAppService is available in macOS 13+ via `import ServiceManagement` — no framework linking needed in pbxproj
  - SMAppService.mainApp.register() and .unregister() both throw — wrap in do/catch and revert toggle state on failure
  - Check current state with SMAppService.mainApp.status == .enabled in onAppear to reflect actual registration state
  - No new files needed — the toggle fits naturally in the existing SettingsView
---

## 2026-02-17 - US-001 (multi-account PRD)
- What was implemented: Account data model and AccountStore for multi-account support. Account struct with id (UUID), email, sessionKey, orgId, and isConfigured computed property. AccountStore as ObservableObject with CRUD operations (add, remove, setActive, update), persistence to UserDefaults (metadata) + Keychain (secrets via account-scoped keys), and migration logic from single-account credentials.
- Files changed:
  - ClaudeUsage/Models/Account.swift (new - Account struct)
  - ClaudeUsage/Services/AccountStore.swift (new - AccountStore class with CRUD, persistence, migration)
  - ClaudeUsage.xcodeproj/project.pbxproj (updated - added Account.swift and AccountStore.swift)
  - prd.json (updated - US-001 passes: true)
- **Learnings for future iterations:**
  - AccountStore uses a separate AccountMetadata struct for UserDefaults persistence to avoid storing secrets outside Keychain
  - Session keys are stored in Keychain scoped by "{accountId}-sessionKey" format
  - Migration checks for empty accounts list and old-style credentials, creates "Account 1" and deletes old keys
  - AccountStore has convenience methods saveSessionKey/saveOrgId that update both Keychain and in-memory model
---

## 2026-02-17 - US-002 (KeychainService multi-account support)
- What was implemented: Multi-account scoped methods were already added to KeychainService during US-001 implementation. This story verified the acceptance criteria are met: save(key:accountId:value:), read(key:accountId:), delete(key:accountId:) methods exist with account-scoped cache keys. Old single-account methods remain for migration. Build passes.
- Files changed:
  - ClaudeUsage/Services/KeychainService.swift (already modified in US-001 - contains both old and new methods)
  - prd.json (updated - US-002 passes: true)
- **Learnings for future iterations:**
  - The multi-account KeychainService methods were co-implemented with AccountStore in US-001 since AccountStore depends on them
  - accountKey helper formats as "{accountId.uuidString}-{key.rawValue}" for scoped storage
  - orgId uses UserDefaults with account-scoped key "claude_org_id_{accountId}" instead of Keychain
  - Cache scoping works by using the full scopedKey (including accountId) as the dictionary key
---

## 2026-02-17 - US-003 (UsageViewModel uses AccountStore)
- What was implemented: Refactored UsageViewModel to depend on AccountStore instead of reading Keychain directly. UsageViewModel now takes AccountStore as init parameter. Polling uses active account's credentials via accountStore.sessionKey(for:) and accountStore.orgId(for:). Added Combine subscription on accountStore.$activeAccountId to cancel old polling and start new when active account changes. Added activeEmail computed property. Updated ClaudeUsageApp to create both AccountStore and UsageViewModel as @StateObject with shared AccountStore instance.
- Files changed:
  - ClaudeUsage/Models/UsageViewModel.swift (updated - takes AccountStore in init, uses account-scoped credentials, watches activeAccountId changes)
  - ClaudeUsage/ClaudeUsageApp.swift (updated - creates AccountStore as @StateObject, passes to UsageViewModel)
  - prd.json (updated - US-003 passes: true)
- **Learnings for future iterations:**
  - Use accountStore.$activeAccountId.removeDuplicates().sink to react to account switches — clears state and restarts polling
  - ClaudeUsageApp needs custom init() to share a single AccountStore between @StateObject properties
  - performFetch now takes accountId parameter to scope Set-Cookie key updates to the correct account
  - SettingsView still uses old KeychainService directly — will need updating in US-007
---

## 2026-02-17 - US-004 (App entry point wiring)
- What was implemented: Updated ContentView and SettingsView to accept AccountStore as @ObservedObject parameter. ClaudeUsageApp passes accountStore to ContentView, and ContentView passes it through to SettingsView when opening the settings window.
- Files changed:
  - ClaudeUsage/ClaudeUsageApp.swift (updated - passes accountStore to ContentView)
  - ClaudeUsage/Views/ContentView.swift (updated - accepts @ObservedObject accountStore, passes to SettingsView)
  - ClaudeUsage/Views/SettingsView.swift (updated - accepts @ObservedObject accountStore)
  - prd.json (updated - US-004 passes: true)
- **Learnings for future iterations:**
  - ContentView and SettingsView both receive AccountStore for future multi-account UI features
  - SettingsView accepts accountStore but still reads/writes via old KeychainService methods — will be updated in US-007
---

## 2026-02-17 - US-005 (Account switcher in dropdown)
- What was implemented: Added account picker (Picker with .menu style) at the top of the ContentView popover. Only visible when accountStore.accounts.count >= 2. Uses Binding with get/set to read activeAccountId and call setActive(id:) on selection change. Each account shows its email as the label.
- Files changed:
  - ClaudeUsage/Views/ContentView.swift (updated - added accountPicker computed property and placed it at top of usageContent VStack)
  - prd.json (updated - US-005 passes: true)
- **Learnings for future iterations:**
  - Use Picker with .menu style and .labelsHidden() for a compact dropdown in the popover
  - Binding(get:set:) pattern needed since activeAccountId is on AccountStore not a local @State
  - Group {} wrapper used to conditionally include the picker without affecting VStack layout when hidden
---
